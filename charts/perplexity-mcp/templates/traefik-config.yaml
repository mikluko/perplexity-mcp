{{- if .Values.auth.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "perplexity-mcp.fullname" . }}-traefik
  labels:
    {{- include "perplexity-mcp.labels" . | nindent 4 }}
data:
  traefik.yaml: |
    # Traefik static configuration
    api:
      dashboard: false

    entryPoints:
      web:
        address: ":{{ .Values.auth.port }}"

    providers:
      file:
        filename: /etc/traefik/conf.d/dynamic.yaml

    log:
      level: ERROR
      format: json

    accessLog:
      format: json

    ping:
      entryPoint: web

  dynamic.yaml: |
    # Traefik dynamic configuration
    http:
      routers:
        mcp:
          rule: "PathPrefix(`/`)"
          service: mcp-backend
          middlewares:
            - basic-auth

      middlewares:
        basic-auth:
          basicAuth:
            usersFile: "/etc/traefik/users"
            realm: "Perplexity MCP"

      services:
        mcp-backend:
          loadBalancer:
            servers:
              - url: "http://127.0.0.1:8080"
{{- end }}
