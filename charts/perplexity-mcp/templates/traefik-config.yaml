{{- if .Values.auth.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "perplexity-mcp.fullname" . }}-traefik
  labels:
    {{- include "perplexity-mcp.labels" . | nindent 4 }}
data:
  traefik.yaml: |
    entryPoints:
      web:
        address: ":{{ .Values.auth.port }}"

    providers:
      file:
        filename: /etc/traefik/conf.d/dynamic.yaml

    ping:
      entryPoint: web

  dynamic.yaml: |
    http:
      routers:
        mcp:
          rule: "PathPrefix(`/`)"
          service: mcp-backend
          middlewares:
            - basic-auth

      middlewares:
        basic-auth:
          basicAuth:
            usersFile: "/etc/traefik/users"

      services:
        mcp-backend:
          loadBalancer:
            servers:
              - url: "http://127.0.0.1:8080"
{{- end }}
